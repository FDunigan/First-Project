<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css?family=Fredericka+the+Great|IM+Fell+DW+Pica+SC|Oswald|Rye|Six+Caps" rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="assets/css/reset.css">
    <link rel="stylesheet" type="text/css" href="assets/style.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js"></script>
    <script src="lodash.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.12.0/firebase.js"></script>
    <title>Watch What You Eat</title>
</head>

<body>
    
    <div class="wrapper">
        
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <h1 class="title">Watch What You Eat</h1>
                </div>
            </div>
        </div>
        
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <p class="about">
                        We believe those with a passion for making great food should be able to spend 
                        more time cooking and less time looking for the right recipe. That's why we 
                        created WATCH WHAT YOU EAT. Our nifty little app connects cooking enthusiasts 
                        with great YouTube cooking videos curated using targeted culinary criteria from 
                        TheMealDB so you can be confident the videos you search for here by dish, 
                        region, category and/or ingredient(s) will be well worth watching. 
                        <br><br>
                        Now Let's Get Cooking!
                    </p>
                </div>
            </div>
        </div>
        
        <div class="container">
            <div class="card">
                <h3 class="card-header">&#8212; Make Your Menu &#8212;</h3>
            </div>   
        </div>
        
        <form>
            <div class="container-form">
                <div class="row">
                    <div class="col-md-1">
                        <div id="hand">&#9758;</div>
                    </div>
                    
                    <div class="col-md-5 form-border">
                        <div class="form-group">
                            <label for="dish" id="label">BY DISH</label>
                            <input type="text" class="form-control" id="dish" placeholder="">
                        </div>
                    </div>
                    
                    <div class="col-md-1">
                        <div id="hand">&#9758;</div>
                    </div>
                    
                    <div class="col-md-5">
                        <div class="form-group">
                            <label for="category" id="label">BY CATEGORY</label>
                            <input type="text" class="form-control" id="category" placeholder="">
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-1">
                        <div id="hand">&#9758;</div>
                    </div>
                    
                    <div class="col-md-5 form-border">
                        <div class="form-group">
                            <label for="region" id="label">BY REGION</label>
                            <input type="text" class="form-control" id="region" placeholder="">
                        </div>
                    </div>
                    
                    <div class="col-md-1">
                        <div id="hand">&#9758;</div>
                    </div>          
                    
                    <div class="col-md-5">
                        <div class="form-group">
                            <label for="ingredients" id="label">BY INGREDIENT</label>
                            <input type="text" class="form-control" id="ingredients" placeholder="">
                        </div>   
                    </div>     
                </div>
            </div>
            <button type="button" class="btn btn-primary" id="btn-search">Search</button>
            
            <button type="button" class="btn btn-primary" id="btn-search" data-toggle="modal" data-target=".bd-example-modal-lg">Search</button>
        </form>
        
        <div class="row">
            <div class="col-md-12">
                <div class="card mb-4">
                    <h3 class="card-header">&#8212; House Specialties &#8212;</h3>
                    <div class="card-body">
                        <table class="table table-sm table-hover" id="ingredient-table">
                            <thead>
                                <tr>
                                    <th scope="col" id="display-head">DISH</th>
                                </tr>
                            </thead>
                            <tbody id="results-body">
                                <td scope="col" id="dish-display"></td>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    
    
    <div class="modal fade bd-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div id="recipe-display" class="modal-content">
                
                
                
                
                
                
                <!-- <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h3 class="modal-header">YOUR RESULTS!</h3>
                </div>
                <div class="modal-body">
                    <div class="container-fluid">
                        <div class="row">
                            <div class="col-md-12">
                                RECIPE
                            </div>
                        </div>
                    </div>
                    <div class="col-md-12">
                        RECIPE
                    </div>
                    
                    
                </div>
                
                <div class="modal-body">
                    <div class="your-video"></div>
                    <h3>YOUR VIDEO</h3>
                    <iframe width="560" height="315" src="https://www.youtube.com/embed/9kRgVxULbag" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div>
                </div>
                 -->
            </div>
        </div>
        
    </div>
    
    
    
    <script type="text/javascript">
        
        var config = {
            apiKey: "AIzaSyDxF1JpYtm5tmGqUsNWIJdFhiPQi7_NFIc",
            authDomain: "projectone-b29b1.firebaseapp.com",
            databaseURL: "https://projectone-b29b1.firebaseio.com",
            projectId: "projectone-b29b1",
            storageBucket: "projectone-b29b1.appspot.com",
            messagingSenderId: "923998700719"
        };
        
        firebase.initializeApp(config);
        
        var database = firebase.database();
        
        var dish = "";
        var category = "";
        var region = "";
        var ingredients = "";
        
        //The function that runs when you submit a search
        $("#btn-search").on("click", function(){
            event.preventDefault();
            $("#results-body").empty();
            //Keeps it from submitting to a database
            
            //creates an array and pushes text field inputs into it
            var categoryArray = [];
            if ( $("#dish").val().trim() != "") {
                var categoryN = "search.php?s=" + $("#dish").val().trim();
                categoryArray.push(categoryN);}
                
                if ( $("#category").val().trim() != "") {
                    var categoryC = "filter.php?c=" + $("#category").val().trim();
                    categoryArray.push(categoryC)}
                    
                    if ( $("#ingredients").val().trim() != "") {
                        var categoryI = "filter.php?i=" + $("#ingredients").val().trim();
                        categoryArray.push(categoryI)}
                        
                        if ( $("#region").val().trim() != "") {
                            var categoryA = "filter.php?a=" + $("#region").val().trim();
                            categoryArray.push(categoryA)}
                            
                            console.log(categoryArray)
                            // setting up an array for filtering
                            var tempArray = [];
                            // Runs multiple GET methods for each query term
                            for (i=0; i<categoryArray.length; i++) {
                                //Sets up the query Url
                                var queryUrl = "https://www.themealdb.com/api/json/v1/1/" + categoryArray[i]
                                console.log(queryUrl)
                                //runs the GET method
                                $.ajax({
                                    url: queryUrl,
                                    method: "GET"
                                }).then(function(response) {
                                    console.log(response.meals);
                                    //Runs a for loop for each meal that comes up each time the GET method is run.
                                    $.each(response.meals, function(index, value) {
                                        //Pushes the meal into the array
                                        tempArray.push(value.strMeal)
                                        //checks to see how many copies of that meal are in the array
                                        // var countNumber = counter(tempArray, value.strMeal)
                                        var countNumber = _.filter(tempArray, function(o){return o == value.strMeal}).length
                                        console.log(tempArray, countNumber);
                                        //If the number of copies of that meal are equal to the number of GET methods run, then it suits all checked categories, and the meal is submitted to the table
                                        if (countNumber == categoryArray.length){
                                            
                                            
                                            var newRow = $("<tr>").append($("<td>").html($("<button>").text(value.strMeal).attr("data-toggle", "modal").attr("data-target", ".bd-example-modal-lg").attr("id", value.idMeal).addClass("btn-recipe")));
                                                            $("#results-body").append(newRow)
            
                                                        }
                                                        else {
                                                            
                                                        }
                                                    });
                                                });
                                            }
                                            
                                        });
                                        
                                        database.ref().on("value", function(snapshot)   {
                                            console.log(snapshot.val().dish);
                                            
                                            $("#dish-display").text(snapshot.val().dish);
                                            $("#category-display").text(snapshot.val().category);
                                            $("#region-display").text(snapshot.val().region);
                                            $("#ingredients-display").text(snapshot.val().ingredients);
                                            
                                        }, function(errorObject)    {
                                            console.log("Errors handled: " + errorObject.code);
                                        });

                                         //Handles the creation of a recipe from clicking on a search result.
                                         $(document).on("click", ".btn-recipe", function(){
                                            event.preventDefault();
                                            console.log("recipe clicker's working, bruh")
                                            //retrieves recipe ID from search result
                                            var recipeID = $(this).attr("id");
                                            //creates query URL
                                            var queryUrl = "https://www.themealdb.com/api/json/v1/1/lookup.php?i=" + recipeID;
                                            //runs ajax
                                            $.ajax({
                                                url: queryUrl,
                                                method: "GET"
                                            }).then(function(response) {
                                                //creates temp HTML elements
                                                var img = $("<img>");
                                                var div = $("<div>");
                                                    $(div).html("<h3>" + response.meals[0].strMeal + "</h3>")
                                                    var formatter = response.meals[0].strInstructions.split('\r\n');
                                                    console.log(formatter)
                                                    for (i = 0; i < formatter.length; i++) {
                                                        var p = $("<p>");
                                                            $(p).text(formatter[i]);
                                                            console.log(p)
                                                            $(div).append(p);}
                                                            
                                                            var btn = $("<button>");
                                                                $(btn).addClass("btn btn-primary save").attr("id", recipeID).text("Save Recipe")
                                                                
                                                                $(img).attr("src", response.meals[0].strMealThumb).addClass("img-responsive")
                                                                var ingArray = [];
                                                                var meaArray = [];
                                                                
                                                                //searches response for ingredients and associated measures, and stores them in arrays
                                                                Object.keys(response.meals[0]).forEach(function(key) {
                                                                    if (key.startsWith("strIngre")){
                                                                        if (response.meals[0][key] != "" || response.meals[0][key] [i] != null) {
                                                                            ingArray.push(response.meals[0][key])
                                                                        }}
                                                                    });
                                                                    
                                                                    Object.keys(response.meals[0]).forEach(function(key) {
                                                                        if (key.startsWith("strMeas")){
                                                                            if (response.meals[0][key] != "" || response.meals[0][key] [i] != null) {
                                                                                meaArray.push(response.meals[0][key])
                                                                            }}
                                                                        });
                                                                        //sticks those ingredients and measures into a temporary element
                                                                        for (var i = 0; i < ingArray.length; i++){
                                                                            $(div).append("<br>" + ingArray[i] + ": " + meaArray[i])
                                                                        }
                                                                        console.log("Still working!")
                                                                        console.log(img, div)
                                                                        $("#recipe-display").append(img).append(div).append(btn)
                                                                    })
                                                                    
                                                                });
                                        
                                        
                                    </script>
                                </body>
                                
                                </html>
                                